{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": []
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## (a)  Load the Data:\n",
    "First, start by loading the data and the package we need."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {},
   "outputs": [],
   "source": [
    "import numpy as np\n",
    "import pandas as pd\n",
    "import statsmodels.api as sm\n",
    "import statsmodels.formula.api as smf"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "As in the Lab, we use pandas to read the data from a `.csv` file, and consolidate it into a `Dataframe` object."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "metadata": {
    "scrolled": true
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "<class 'pandas.core.frame.DataFrame'>\n",
      "RangeIndex: 162 entries, 0 to 161\n",
      "Data columns (total 8 columns):\n",
      " #   Column        Non-Null Count  Dtype  \n",
      "---  ------        --------------  -----  \n",
      " 0   MonthNumeric  162 non-null    int64  \n",
      " 1   MonthFactor   162 non-null    object \n",
      " 2   Year          162 non-null    int64  \n",
      " 3   RogueSales    162 non-null    int64  \n",
      " 4   Unemployment  162 non-null    float64\n",
      " 5   RogueQueries  162 non-null    int64  \n",
      " 6   CPIAll        162 non-null    float64\n",
      " 7   CPIEnergy     162 non-null    float64\n",
      "dtypes: float64(3), int64(4), object(1)\n",
      "memory usage: 10.2+ KB\n"
     ]
    }
   ],
   "source": [
    "sales = pd.read_csv('Rogue-242-Fall2021.csv')\n",
    "sales.info()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Start by looking at the data and identifying the variables (first 5 lines)."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>MonthNumeric</th>\n",
       "      <th>MonthFactor</th>\n",
       "      <th>Year</th>\n",
       "      <th>RogueSales</th>\n",
       "      <th>Unemployment</th>\n",
       "      <th>RogueQueries</th>\n",
       "      <th>CPIAll</th>\n",
       "      <th>CPIEnergy</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>1</td>\n",
       "      <td>January</td>\n",
       "      <td>2008</td>\n",
       "      <td>5435</td>\n",
       "      <td>5.0</td>\n",
       "      <td>18</td>\n",
       "      <td>212.174</td>\n",
       "      <td>226.775</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>2</td>\n",
       "      <td>February</td>\n",
       "      <td>2008</td>\n",
       "      <td>5223</td>\n",
       "      <td>4.9</td>\n",
       "      <td>11</td>\n",
       "      <td>212.687</td>\n",
       "      <td>229.731</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>3</td>\n",
       "      <td>March</td>\n",
       "      <td>2008</td>\n",
       "      <td>6873</td>\n",
       "      <td>5.1</td>\n",
       "      <td>18</td>\n",
       "      <td>213.448</td>\n",
       "      <td>233.349</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>4</td>\n",
       "      <td>April</td>\n",
       "      <td>2008</td>\n",
       "      <td>5814</td>\n",
       "      <td>5.0</td>\n",
       "      <td>17</td>\n",
       "      <td>213.942</td>\n",
       "      <td>234.778</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>5</td>\n",
       "      <td>May</td>\n",
       "      <td>2008</td>\n",
       "      <td>7467</td>\n",
       "      <td>5.4</td>\n",
       "      <td>17</td>\n",
       "      <td>215.208</td>\n",
       "      <td>243.924</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "   MonthNumeric MonthFactor  Year  RogueSales  Unemployment  RogueQueries  \\\n",
       "0             1     January  2008        5435           5.0            18   \n",
       "1             2    February  2008        5223           4.9            11   \n",
       "2             3       March  2008        6873           5.1            18   \n",
       "3             4       April  2008        5814           5.0            17   \n",
       "4             5         May  2008        7467           5.4            17   \n",
       "\n",
       "    CPIAll  CPIEnergy  \n",
       "0  212.174    226.775  \n",
       "1  212.687    229.731  \n",
       "2  213.448    233.349  \n",
       "3  213.942    234.778  \n",
       "4  215.208    243.924  "
      ]
     },
     "execution_count": 5,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "sales.head(5)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Start by splitting the data into a training set and two testing sets, testing set A and testing set B. The training set should contain all observations from 2008 through 2015. Testing set A should have all observations from January 2016 through December 2019, and testing set B should have all observations from January 2020 through July 2021."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "metadata": {},
   "outputs": [],
   "source": [
    "training_set = sales[(sales['Year'] <= 2015) & (sales['Year'] >= 2008 )]\n",
    "\n",
    "testing_setA = sales[(sales['Year'] <= 2019) & (sales['Year'] >= 2016 )]\n",
    "\n",
    "testing_setB = sales[(sales['Year'] >= 2020)]\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "###  Training the Model\n",
    "\n",
    "We will use syntaxis that follows R-style formulas."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "I consider  just  the  four  independent  variables : Unemployment, RogueQueries, CPIEnergy,  and CPIAll.  Using  my regression skills, I construct a regression model to predict monthly Rogue sales (RogueSales).  "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "                            OLS Regression Results                            \n",
      "==============================================================================\n",
      "Dep. Variable:             RogueSales   R-squared:                       0.796\n",
      "Model:                            OLS   Adj. R-squared:                  0.787\n",
      "Method:                 Least Squares   F-statistic:                     88.71\n",
      "Date:                Tue, 21 Sep 2021   Prob (F-statistic):           1.47e-30\n",
      "Time:                        18:23:48   Log-Likelihood:                -898.41\n",
      "No. Observations:                  96   AIC:                             1807.\n",
      "Df Residuals:                      91   BIC:                             1820.\n",
      "Df Model:                           4                                         \n",
      "Covariance Type:            nonrobust                                         \n",
      "================================================================================\n",
      "                   coef    std err          t      P>|t|      [0.025      0.975]\n",
      "--------------------------------------------------------------------------------\n",
      "Intercept    -6.918e+04   1.42e+04     -4.884      0.000   -9.73e+04    -4.1e+04\n",
      "Unemployment  -138.5673    245.091     -0.565      0.573    -625.411     348.276\n",
      "RogueQueries   172.2780     57.473      2.998      0.004      58.115     286.441\n",
      "CPIEnergy      -65.8007     15.636     -4.208      0.000     -96.859     -34.742\n",
      "CPIAll         410.8467     76.709      5.356      0.000     258.474     563.219\n",
      "==============================================================================\n",
      "Omnibus:                       61.772   Durbin-Watson:                   1.459\n",
      "Prob(Omnibus):                  0.000   Jarque-Bera (JB):              442.090\n",
      "Skew:                           1.883   Prob(JB):                     1.00e-96\n",
      "Kurtosis:                      12.815   Cond. No.                     1.55e+04\n",
      "==============================================================================\n",
      "\n",
      "Warnings:\n",
      "[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.\n",
      "[2] The condition number is large, 1.55e+04. This might indicate that there are\n",
      "strong multicollinearity or other numerical problems.\n"
     ]
    }
   ],
   "source": [
    "model_1 = smf.ols(formula='RogueSales ~ Unemployment + RogueQueries + CPIEnergy + CPIAll' ,\n",
    "                 data=training_set).fit()\n",
    "\n",
    "print(model_1.summary())"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "In order to choose which of the four variables to use in my model in order to build a high-quality linear regression model, I will calculate the Variance Inflation Factor. "
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Variance Inflation Factor (VIF)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Calculate Variance Inflation Factor for each explanatory variable\n",
    "\n",
    "from statsmodels.stats.outliers_influence import variance_inflation_factor\n",
    "\n",
    "def VIF(df, columns):\n",
    "    \n",
    "    values = sm.add_constant(df[columns]).values  \n",
    "    num_columns = len(columns)+1\n",
    "    vif = [variance_inflation_factor(values, i) for i in range(num_columns)]\n",
    "    \n",
    "    return pd.Series(vif[1:], index=columns)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "Unemployment    1.828038\n",
       "RogueQueries    6.072534\n",
       "CPIEnergy       1.551640\n",
       "CPIAll          5.330401\n",
       "dtype: float64"
      ]
     },
     "execution_count": 9,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "cols_1 = ['Unemployment', 'RogueQueries', 'CPIEnergy', 'CPIAll']\n",
    "VIF(training_set , cols_1)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "The VIF of the variable \"RogueQueries\" is high ($VIF(RogueQueries = 6.07)$) and its P-value is high ($0.573$). In order to obtain a better model, i will compute a new model by removing the variable \"RogueQueries\" and look at the $R^2$ of the new model."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### A better model... : we will remove \"RogueQueries \""
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "                            OLS Regression Results                            \n",
      "==============================================================================\n",
      "Dep. Variable:             RogueSales   R-squared:                       0.776\n",
      "Model:                            OLS   Adj. R-squared:                  0.768\n",
      "Method:                 Least Squares   F-statistic:                     106.1\n",
      "Date:                Tue, 21 Sep 2021   Prob (F-statistic):           9.28e-30\n",
      "Time:                        18:23:48   Log-Likelihood:                -902.93\n",
      "No. Observations:                  96   AIC:                             1814.\n",
      "Df Residuals:                      92   BIC:                             1824.\n",
      "Df Model:                           3                                         \n",
      "Covariance Type:            nonrobust                                         \n",
      "================================================================================\n",
      "                   coef    std err          t      P>|t|      [0.025      0.975]\n",
      "--------------------------------------------------------------------------------\n",
      "Intercept    -1.003e+05      1e+04    -10.005      0.000    -1.2e+05   -8.04e+04\n",
      "Unemployment  -515.0492    219.408     -2.347      0.021    -950.813     -79.285\n",
      "CPIEnergy      -89.7759     14.006     -6.410      0.000    -117.593     -61.958\n",
      "CPIAll         605.5035     42.567     14.225      0.000     520.961     690.045\n",
      "==============================================================================\n",
      "Omnibus:                       46.707   Durbin-Watson:                   1.403\n",
      "Prob(Omnibus):                  0.000   Jarque-Bera (JB):              212.025\n",
      "Skew:                           1.482   Prob(JB):                     9.11e-47\n",
      "Kurtosis:                       9.650   Cond. No.                     1.05e+04\n",
      "==============================================================================\n",
      "\n",
      "Warnings:\n",
      "[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.\n",
      "[2] The condition number is large, 1.05e+04. This might indicate that there are\n",
      "strong multicollinearity or other numerical problems.\n"
     ]
    }
   ],
   "source": [
    "import statsmodels.formula.api as smf\n",
    "\n",
    "model_2 = smf.ols(formula='RogueSales ~ Unemployment  + CPIEnergy + CPIAll' ,\n",
    "                 data=training_set).fit()\n",
    "\n",
    "print(model_2.summary())"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "The $R^2$ of this second model (equal to $0.768$) is almost the same than the $R^2$ of the first model ($0.787$). It is thus justifiied to remove the variable \"RogueQueries\" who was correlated with the other independent variables. Now all the P-values are low. \n",
    "To see if we can remove other variables, we recalculate the VIF of each variables of the new model. "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "Unemployment    1.347993\n",
       "CPIEnergy       1.145628\n",
       "CPIAll          1.510322\n",
       "dtype: float64"
      ]
     },
     "execution_count": 11,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "cols_2 = ['Unemployment', 'CPIEnergy', 'CPIAll']\n",
    "VIF(training_set , cols_2)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "In order to have a better model, we can try to remove the variable with the higher VIF, that is CPIAll. We then compute the new model without this variable. "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "                            OLS Regression Results                            \n",
      "==============================================================================\n",
      "Dep. Variable:             RogueSales   R-squared:                       0.283\n",
      "Model:                            OLS   Adj. R-squared:                  0.267\n",
      "Method:                 Least Squares   F-statistic:                     18.31\n",
      "Date:                Tue, 21 Sep 2021   Prob (F-statistic):           1.97e-07\n",
      "Time:                        18:23:48   Log-Likelihood:                -958.75\n",
      "No. Observations:                  96   AIC:                             1923.\n",
      "Df Residuals:                      93   BIC:                             1931.\n",
      "Df Model:                           2                                         \n",
      "Covariance Type:            nonrobust                                         \n",
      "================================================================================\n",
      "                   coef    std err          t      P>|t|      [0.025      0.975]\n",
      "--------------------------------------------------------------------------------\n",
      "Intercept      3.32e+04   6277.786      5.289      0.000    2.07e+04    4.57e+04\n",
      "Unemployment -2054.1884    339.569     -6.049      0.000   -2728.505   -1379.872\n",
      "CPIEnergy      -23.8425     23.513     -1.014      0.313     -70.536      22.851\n",
      "==============================================================================\n",
      "Omnibus:                        2.821   Durbin-Watson:                   0.443\n",
      "Prob(Omnibus):                  0.244   Jarque-Bera (JB):                2.362\n",
      "Skew:                          -0.192   Prob(JB):                        0.307\n",
      "Kurtosis:                       3.665   Cond. No.                     2.64e+03\n",
      "==============================================================================\n",
      "\n",
      "Warnings:\n",
      "[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.\n",
      "[2] The condition number is large, 2.64e+03. This might indicate that there are\n",
      "strong multicollinearity or other numerical problems.\n"
     ]
    }
   ],
   "source": [
    "import statsmodels.formula.api as smf\n",
    "\n",
    "model_3 = smf.ols(formula='RogueSales ~ Unemployment  + CPIEnergy ' ,\n",
    "                 data=training_set).fit()\n",
    "\n",
    "print(model_3.summary())"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "The $R^2$ is now very low (equal to $0.267$) in comparation of the $R^2$ of the second model. I conclude that the second model was the best I can obtain with the four variable and the training data."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "I decide to use the variables : Unemployment, CPIEnergy, CPIAll, in the model. The $R^2$ that evalues the quality of the linear regression model’s predictions using the training set is equal to $0.768$. "
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Explanation (a)\n",
    "The dependent variable is \"RogueSales\" and we consider at first the four following independente variables: 'Unemployment', 'RogueQueries', 'CPIEnergy', 'CPIAll'. \n",
    "The computation of the linear regression gives the following linear regression equation: \n",
    "$RogueSales = -6.918*10^4 + 138.5673 * Unemployment + 172.2780 * RogueQueries - 65.8007 * CPIEnergy + 410.8467 * CPIAll. $\n",
    "\n",
    "To improve the model, we looked at the P-values and we calculated the VIF. High P-values and high VIF for a variable means that the variable is dependent from the other independent variables. “RoguesQueries” has a high VIP ($6.07$). \n",
    "To see if the variable is corelated with the other independent variables, we compute the linear regression with the three following independente variables: 'Unemployment', 'CPIEnergy', 'CPIAll', and we check if the $R^2$ don’t decrease too much. \n",
    "Without “RoguesQueries”, the $R^2$ is equal to $0.776$ against $0.796$ with “RoguesQueries”, (which is not considerably different). \n",
    "\n",
    "When we recalculate the linear regression equation with the three variables, the $R^2$ is quite good ($0.776$), the P-values are low for the three independent variables (less than $0.02$) and the VIF are also low for each variable (less than $1.6$). \n",
    "\n",
    "Finally, I obtain the linear regression equation: \n",
    "$RogueSales = -1.003*10^5 -515.0492* Unemployment - 89.7759* CPIEnergy + 605.5035* CPIAll. $\n",
    "\n",
    "\n",
    "From this equation, we can interpret that Rogue’s sales increase proportionality and with the CIP (customer price index). The dependence with the CPI seems logical: if the sales increase, prices paid by consumer households for goods and services increase also. Rogue’s sales also decrease proportionality with the increase of Unemployment. It seems also logical because I assume that when unemployment increases, consumer have less money to spend in cars and sales decrease. Finally, Rogue’s sales also decrease proportionality with the increase of CPIEnergy (customer price index for the energy sector). This time, it seems not logical because I believe that there would have been a positive dependency between Rogue’sales and CPIEnergy (people who buy a new car would spend more money in energy, but maybe, by buying a new car, people would have a car which consume less energy which will make their energy consumption decreases).\n",
    "\n",
    "The model seems to predict well the sells (but not very well). The $R^2$ is equal to $0.776$, which is good but not excellent. \n",
    "\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## (b) Trying to improve the linear regression model by modeling seasonality."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "\n",
    "I construct a new linear regression model using the MonthFactorvariable as an independent variable, in addition to all four of the variables I used at the start of part(a).\n",
    "\n",
    "I don't do variable selection for this part of the problem and as before, I construct the model based on the training data.\n",
    "\n",
    "\n",
    "\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "                            OLS Regression Results                            \n",
      "==============================================================================\n",
      "Dep. Variable:             RogueSales   R-squared:                       0.851\n",
      "Model:                            OLS   Adj. R-squared:                  0.823\n",
      "Method:                 Least Squares   F-statistic:                     30.46\n",
      "Date:                Tue, 21 Sep 2021   Prob (F-statistic):           7.49e-27\n",
      "Time:                        18:23:48   Log-Likelihood:                -883.30\n",
      "No. Observations:                  96   AIC:                             1799.\n",
      "Df Residuals:                      80   BIC:                             1840.\n",
      "Df Model:                          15                                         \n",
      "Covariance Type:            nonrobust                                         \n",
      "============================================================================================\n",
      "                               coef    std err          t      P>|t|      [0.025      0.975]\n",
      "--------------------------------------------------------------------------------------------\n",
      "Intercept                -8.216e+04   1.41e+04     -5.845      0.000    -1.1e+05   -5.42e+04\n",
      "MonthFactor[T.August]     3280.0709   1344.593      2.439      0.017     604.245    5955.896\n",
      "MonthFactor[T.Decemeber]   976.4637   1323.099      0.738      0.463   -1656.587    3609.515\n",
      "MonthFactor[T.February]   2724.2250   1320.184      2.064      0.042      96.975    5351.475\n",
      "MonthFactor[T.January]    -976.9897   1326.575     -0.736      0.464   -3616.959    1662.979\n",
      "MonthFactor[T.July]       1713.7269   1338.649      1.280      0.204    -950.269    4377.723\n",
      "MonthFactor[T.June]        605.8386   1320.488      0.459      0.648   -2022.015    3233.693\n",
      "MonthFactor[T.March]      3990.3761   1322.016      3.018      0.003    1359.481    6621.271\n",
      "MonthFactor[T.May]        2682.1772   1313.479      2.042      0.044      68.270    5296.084\n",
      "MonthFactor[T.November]   -255.6589   1322.607     -0.193      0.847   -2887.731    2376.413\n",
      "MonthFactor[T.October]     179.6851   1320.181      0.136      0.892   -2447.559    2806.929\n",
      "MonthFactor[T.Septeber]    689.5712   1315.836      0.524      0.602   -1929.025    3308.168\n",
      "Unemployment              -266.8447    229.344     -1.164      0.248    -723.253     189.564\n",
      "RogueQueries               111.2632     58.459      1.903      0.061      -5.075     227.601\n",
      "CPIEnergy                  -78.2961     15.220     -5.144      0.000    -108.586     -48.006\n",
      "CPIAll                     486.4558     77.483      6.278      0.000     332.260     640.651\n",
      "==============================================================================\n",
      "Omnibus:                       70.261   Durbin-Watson:                   1.174\n",
      "Prob(Omnibus):                  0.000   Jarque-Bera (JB):              655.246\n",
      "Skew:                           2.117   Prob(JB):                    5.19e-143\n",
      "Kurtosis:                      15.078   Cond. No.                     1.69e+04\n",
      "==============================================================================\n",
      "\n",
      "Warnings:\n",
      "[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.\n",
      "[2] The condition number is large, 1.69e+04. This might indicate that there are\n",
      "strong multicollinearity or other numerical problems.\n"
     ]
    }
   ],
   "source": [
    "# Choose the features to be used\n",
    "cols_4 = ['Unemployment', 'RogueQueries', 'CPIEnergy', 'CPIAll', 'MonthFactor']\n",
    "X_train_4 = training_set[cols_4]\n",
    "y_train = training_set['RogueSales']\n",
    "\n",
    "\n",
    "import statsmodels.formula.api as smf\n",
    "\n",
    "model_4 = smf.ols(formula='RogueSales ~ Unemployment + RogueQueries + CPIEnergy + CPIAll + MonthFactor' ,\n",
    "                 data=training_set).fit()\n",
    "\n",
    "print(model_4.summary())"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "<class 'pandas.core.frame.DataFrame'>\n",
      "RangeIndex: 162 entries, 0 to 161\n",
      "Data columns (total 10 columns):\n",
      " #   Column        Non-Null Count  Dtype  \n",
      "---  ------        --------------  -----  \n",
      " 0   MonthNumeric  162 non-null    int64  \n",
      " 1   MonthFactor   162 non-null    object \n",
      " 2   Year          162 non-null    int64  \n",
      " 3   RogueSales    162 non-null    int64  \n",
      " 4   Unemployment  162 non-null    float64\n",
      " 5   RogueQueries  162 non-null    int64  \n",
      " 6   CPIAll        162 non-null    float64\n",
      " 7   CPIEnergy     162 non-null    float64\n",
      " 8   Cars          162 non-null    object \n",
      " 9   Season        162 non-null    object \n",
      "dtypes: float64(3), int64(4), object(3)\n",
      "memory usage: 12.8+ KB\n"
     ]
    }
   ],
   "source": [
    "sales_new = pd.read_csv('Rogue-242-new.csv')\n",
    "sales_new.info()\n",
    "\n",
    "training_set_new = sales_new[(sales_new['Year'] <= 2015) & (sales_new['Year'] >= 2008 )]\n",
    "\n",
    "testing_setA_new = sales_new[(sales_new['Year'] <= 2019) & (sales_new['Year'] >= 2016 )]\n",
    "\n",
    "testing_setB_new = sales_new[(sales_new['Year'] >= 2020)]\n",
    "\n",
    "\n",
    "\n",
    "# Choose the features to be used\n",
    "cols_5 = ['Unemployment', 'RogueQueries', 'CPIEnergy', 'CPIAll', 'Season']\n",
    "X_train_5 = training_set_new[cols_5]\n",
    "y_train = training_set_new['RogueSales']\n",
    "\n",
    "\n",
    "import statsmodels.formula.api as smf\n",
    "\n",
    "model_5 = smf.ols(formula='RogueSales ~ Unemployment + RogueQueries + CPIEnergy + CPIAll + Season' ,\n",
    "                 data=training_set_new).fit()\n",
    "\n",
    "#print(model_5.summary())"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Explanation (b)\n",
    "\n",
    "The model is now: \n",
    "\n",
    "$RogueSales = -1.029*10^5 - -504.3271* Unemployment -95.0297* CPIEnergy + 615.3480* CPIAll -976.9897* 1_{January}* +2724.2250* 1_{February} + 3990.3761*1_{March} + 2682.1772* 1_{May} + 605.8386* 1_{June} + 1713.7269* 1_{July} + 3280.0709* 1_{August} + 689.5712* 1_{September} + 179.6851* 1_{October} -255.6589* 1_{November} + 976.4637* 1_{December}. $\n",
    "\n",
    "(where $1_{Month} = 1 $if $Monthfactor = Month$ and $1_{Month} = 0$ otherwise.) \n",
    "\n",
    "The coefficients of Monthfactor variables seem not easy to interpret. In January, April and November, sales are decreasing, while in March, May and July, sales are increasing. The sales don’t seem to be correlated by the seasons (spring, fall, summer, winter). \n",
    "\n",
    "The $R^2$ is now equal to $0.851$. It is higher than the $R^2$ we had in the last model. When we look at the P-values and the confidence intervals, we see that the signific variables are CPIAll, CPIEnergy, and the month factors associated with the months May, March, August, and February. \n",
    "\n",
    "I think adding the variable Monthfactor improve over model, because the $R^2$ and the Adjusted $R^2$ are higher than the last $R^2$ and adjusted $R^2$ we had. But I also think it is possible to use the given data to model seasonality in a different way to improve our model \n",
    "\n",
    "To improve the model, we can classify the seasons according to the fact that it makes the sales increase a lot or decrease or increase a bit. \n",
    "We can use three classes: \n",
    "Increase_a_lot_class: March, May, August, February\n",
    "Descrease_class: January, April, November\n",
    "Increase_a_bit: June, July, September, October, December\n",
    "\n",
    "After computating it, I realize that it didn't improve the best model I have construct so far."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## (c) Building a final model using a subset of the independent variables used in parts a and b."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "We saw in question (b) that RogueQueries variable was colinear with the three following variables: 'Unemployment', 'RogueQueries', 'CPIEnergy', 'CPIAll'. We can thus remove it from the model. As we saw in question (c), 'MonthFactor' variable improve the model, we can add this variable in the model. We can compute the model with the four variables :  'Unemployment', 'RogueQueries', 'CPIEnergy', 'CPIAll' and 'MonthFactor'."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "                            OLS Regression Results                            \n",
      "==============================================================================\n",
      "Dep. Variable:             RogueSales   R-squared:                       0.831\n",
      "Model:                            OLS   Adj. R-squared:                  0.805\n",
      "Method:                 Least Squares   F-statistic:                     31.12\n",
      "Date:                Tue, 21 Sep 2021   Prob (F-statistic):           2.86e-26\n",
      "Time:                        18:23:48   Log-Likelihood:                -889.21\n",
      "No. Observations:                  96   AIC:                             1806.\n",
      "Df Residuals:                      82   BIC:                             1842.\n",
      "Df Model:                          13                                         \n",
      "Covariance Type:            nonrobust                                         \n",
      "============================================================================================\n",
      "                               coef    std err          t      P>|t|      [0.025      0.975]\n",
      "--------------------------------------------------------------------------------------------\n",
      "Intercept                -1.174e+05   7293.580    -16.097      0.000   -1.32e+05   -1.03e+05\n",
      "MonthFactor[T.August]     3701.2497   1381.987      2.678      0.009     952.037    6450.462\n",
      "MonthFactor[T.Decemeber]   695.7806   1385.379      0.502      0.617   -2060.180    3451.742\n",
      "MonthFactor[T.February]   3024.0500   1379.523      2.192      0.031     279.740    5768.360\n",
      "MonthFactor[T.January]    -570.4275   1380.142     -0.413      0.680   -3315.970    2175.115\n",
      "MonthFactor[T.July]       2111.5313   1381.209      1.529      0.130    -636.134    4859.196\n",
      "MonthFactor[T.June]        784.6969   1380.502      0.568      0.571   -1961.562    3530.956\n",
      "MonthFactor[T.March]      4290.7038   1379.392      3.111      0.003    1546.654    7034.753\n",
      "MonthFactor[T.May]        2669.7229   1379.437      1.935      0.056     -74.418    5413.863\n",
      "MonthFactor[T.November]   -610.6476   1382.236     -0.442      0.660   -3360.356    2139.060\n",
      "MonthFactor[T.October]    -137.5030   1381.274     -0.100      0.921   -2885.296    2610.290\n",
      "MonthFactor[T.Septeber]    585.9093   1381.780      0.424      0.673   -2162.892    3334.710\n",
      "CPIEnergy                  -96.5495     13.037     -7.406      0.000    -122.485     -70.614\n",
      "CPIAll                     664.4173     34.311     19.365      0.000     596.162     732.673\n",
      "==============================================================================\n",
      "Omnibus:                       44.914   Durbin-Watson:                   1.075\n",
      "Prob(Omnibus):                  0.000   Jarque-Bera (JB):              203.187\n",
      "Skew:                           1.412   Prob(JB):                     7.56e-45\n",
      "Kurtosis:                       9.544   Cond. No.                     8.34e+03\n",
      "==============================================================================\n",
      "\n",
      "Warnings:\n",
      "[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.\n",
      "[2] The condition number is large, 8.34e+03. This might indicate that there are\n",
      "strong multicollinearity or other numerical problems.\n"
     ]
    }
   ],
   "source": [
    "\n",
    "# Choose the features to be used\n",
    "cols_5 = [ 'CPIEnergy', 'CPIAll', 'MonthFactor']\n",
    "X_train_5 = training_set[cols_5]\n",
    "y_train = training_set['RogueSales']\n",
    "\n",
    "\n",
    "import statsmodels.formula.api as smf\n",
    "\n",
    "model_5 = smf.ols(formula='RogueSales ~  CPIEnergy + CPIAll + MonthFactor' ,\n",
    "                 data=training_set).fit()\n",
    "\n",
    "print(model_5.summary())"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "The training set $R^2$ is equal to $0.831$."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "I will calculate the $OSR^2$ values for testing set A and testing set B. "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 16,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Compute Out-of-sample R-squared using the test set\n",
    "\n",
    "def OSR2(model, df_train, df_test, dependent_var):   \n",
    "    \n",
    "    y_test = df_test[dependent_var]\n",
    "    y_pred = model.predict(df_test)\n",
    "    SSE = np.sum((y_test - y_pred)**2)\n",
    "    SST = np.sum((y_test - np.mean(df_train[dependent_var]))**2)    \n",
    "    \n",
    "    return 1 - SSE/SST"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 17,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "0.8910826970531923\n"
     ]
    }
   ],
   "source": [
    "OSR2_test_A = OSR2(model_5, training_set, testing_setA, 'RogueSales')\n",
    "print(OSR2_test_A)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 18,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "-0.6638980515646706\n"
     ]
    }
   ],
   "source": [
    "OSR2_test_B = OSR2(model_5, training_set, testing_setB, 'RogueSales')\n",
    "print(OSR2_test_B)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### (c) Explanation\n",
    "\n",
    "We chose to remove the variables : 'RogueQueries' and ‘Unemployement’ from the model and to keep the other because we saw in the last question that their P-values were high and zero was contained in their confidence interval. \n",
    "\n",
    "The training set $R^2$ is equal to $0.831$, which means the model is very good. When we test the model on the test data, we obtain a $OSR_2$ equal to $0.89$ for the testing set A which is very good. But when we test the model on the test data B, we obtain an $OSR_2$ equal to $-0.66$ which means the model don't modelize the test set at all. \n",
    "\n",
    "The $R^2$ and the $OSR_2$ for the data set A are almost equal, which means that the model and the variables succed well to modelize the dependence between the sales and the independence variables. At contrary, the $OSR_2$ for the data set B is very low (and negative) that make me think that the variables from the test set B are following a different law than these from the training set and the test set A. We can assume that the sales from the test set B are following a different law because of the impact the COVID had on the global economy. "
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## (d) Let   now  consider  adding  an  additional  feature/variable  to  the  final  model from part(c).\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "The total vehicule sales in the US seems to me related to the Rogue's sales. I believe that Rogue's sales have evoluted the same than total vehicule sales in the US. I will build  a  new  regression  model  with  my  additional  chosen  feature  in  addition  to  thefeatures that I selected in part(c)."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Including new data  into the previous dataframe"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 19,
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/Users/emmascharfmann/opt/anaconda3/lib/python3.7/site-packages/ipykernel_launcher.py:10: SettingWithCopyWarning: \n",
      "A value is trying to be set on a copy of a slice from a DataFrame.\n",
      "Try using .loc[row_indexer,col_indexer] = value instead\n",
      "\n",
      "See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n",
      "  # Remove the CWD from sys.path while we load stuff.\n"
     ]
    }
   ],
   "source": [
    "sales2 = pd.read_csv('TOTALSA.csv')\n",
    "\n",
    "training_set2 = sales2[(sales2['DATE'] <= '2015-12-01') & (sales2['DATE'] >= '2008-01-01' )]\n",
    "\n",
    "testing_set2A = sales2[(sales2['DATE'] <= '2019-12-01') & (sales2['DATE'] >= '2016-01-01' )]\n",
    "\n",
    "testing_set2B = sales2[(sales2['DATE'] >= '2020-01-01')& (sales2['DATE'] <= '2021-07-01' )]\n",
    "\n",
    "train = training_set2.reset_index()\n",
    "training_set['TotalSale'] = train['TOTALSA']\n",
    "\n",
    "testA = testing_set2A.reset_index()\n",
    "testing_setA = testing_setA.reset_index()\n",
    "\n",
    "testing_setA['TotalSale'] = testA['TOTALSA']\n",
    "\n",
    "testB = testing_set2B.reset_index()\n",
    "testing_setB = testing_setB.reset_index()\n",
    "testing_setB['TotalSale'] = testB['TOTALSA']"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "###  New training the Model\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 20,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "                            OLS Regression Results                            \n",
      "==============================================================================\n",
      "Dep. Variable:             RogueSales   R-squared:                       0.860\n",
      "Model:                            OLS   Adj. R-squared:                  0.836\n",
      "Method:                 Least Squares   F-statistic:                     35.61\n",
      "Date:                Tue, 21 Sep 2021   Prob (F-statistic):           1.01e-28\n",
      "Time:                        18:23:48   Log-Likelihood:                -880.23\n",
      "No. Observations:                  96   AIC:                             1790.\n",
      "Df Residuals:                      81   BIC:                             1829.\n",
      "Df Model:                          14                                         \n",
      "Covariance Type:            nonrobust                                         \n",
      "============================================================================================\n",
      "                               coef    std err          t      P>|t|      [0.025      0.975]\n",
      "--------------------------------------------------------------------------------------------\n",
      "Intercept                -8.179e+04    1.1e+04     -7.445      0.000   -1.04e+05   -5.99e+04\n",
      "MonthFactor[T.August]     3515.4331   1267.042      2.775      0.007     994.416    6036.450\n",
      "MonthFactor[T.Decemeber]  1020.3735   1271.819      0.802      0.425   -1510.148    3550.895\n",
      "MonthFactor[T.February]   3091.8849   1264.076      2.446      0.017     576.770    5607.000\n",
      "MonthFactor[T.January]    -636.3057   1264.638     -0.503      0.616   -3152.538    1879.927\n",
      "MonthFactor[T.July]       2281.4763   1266.196      1.802      0.075    -237.857    4800.810\n",
      "MonthFactor[T.June]        983.5543   1265.802      0.777      0.439   -1534.994    3502.103\n",
      "MonthFactor[T.March]      4084.5039   1264.855      3.229      0.002    1567.838    6601.169\n",
      "MonthFactor[T.May]        2654.8012   1263.894      2.100      0.039     140.048    5169.555\n",
      "MonthFactor[T.November]   -284.4262   1268.970     -0.224      0.823   -2809.278    2240.426\n",
      "MonthFactor[T.October]     391.1942   1272.175      0.308      0.759   -2140.036    2922.424\n",
      "MonthFactor[T.Septeber]   1029.3212   1270.683      0.810      0.420   -1498.939    3557.581\n",
      "CPIEnergy                  -99.6910     11.970     -8.328      0.000    -123.508     -75.874\n",
      "CPIAll                     455.9415     59.951      7.605      0.000     336.658     575.225\n",
      "TotalSale                  848.0589    207.656      4.084      0.000     434.888    1261.230\n",
      "==============================================================================\n",
      "Omnibus:                       59.539   Durbin-Watson:                   1.185\n",
      "Prob(Omnibus):                  0.000   Jarque-Bera (JB):              471.693\n",
      "Skew:                           1.742   Prob(JB):                    3.74e-103\n",
      "Kurtosis:                      13.285   Cond. No.                     1.37e+04\n",
      "==============================================================================\n",
      "\n",
      "Warnings:\n",
      "[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.\n",
      "[2] The condition number is large, 1.37e+04. This might indicate that there are\n",
      "strong multicollinearity or other numerical problems.\n"
     ]
    }
   ],
   "source": [
    "cols_6 = [ 'CPIEnergy', 'CPIAll' , 'MonthFactor', 'TotalSale']\n",
    "X_train_6 = training_set[cols_6]\n",
    "y_train = training_set['RogueSales']\n",
    "\n",
    "\n",
    "import statsmodels.formula.api as smf\n",
    "\n",
    "model_6 = smf.ols(formula='RogueSales ~ MonthFactor + CPIEnergy + CPIAll  + TotalSale ' ,\n",
    "                 data=training_set).fit()\n",
    "\n",
    "print(model_6.summary())"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 21,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "0.8741475858872654\n",
      "0.3434638594818935\n"
     ]
    }
   ],
   "source": [
    "OSR2_test_A = OSR2(model_6, training_set, testing_setA, 'RogueSales')\n",
    "print(OSR2_test_A)\n",
    "\n",
    "OSR2_test_B = OSR2(model_6, training_set, testing_setB, 'RogueSales')\n",
    "print(OSR2_test_B)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "scrolled": true
   },
   "source": [
    "### (d) Explanation\n",
    "In comparaison with the model of question question (c), the $R^2$ is a bit higher ($0.83$ against $0.80$), so the model is a better than the last one when we only look at the training data. When we test the model with the test data, we have nearly the same $OSR_2$ for the testing set A which is still excellent ($0.87$ against $0.89$) but the $OSR_2$ for the testing set B is better than for the last model ($0.34$ against $-0,66$). However, even if it is better then the last one, the model is still not good when we apply it to the testing set B"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## (e) loss function l"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Consider that $\\hat{y}$ is the number of Rogue units to be sold in a month. \n",
    "Let $y$ bet the demand of Rogue cars in a month. \n",
    "\n",
    "The number of units sold in a month : \n",
    "- $y$ if $y \\leq \\hat{y}$ : sells are equal to the demand if the demand is lower than the units to be sold.\n",
    "- $\\hat{y}$ if $y \\geq \\hat{y} $ : sells are equal to the units to be sold if the demand is higher than the units to be sold.\n",
    "\n",
    "The profit from the sells is : $ min(y,\\hat{y}) *3000$ $\n",
    "\n",
    "The number of units which are not sold in a month is : \n",
    "- $\\hat{y} - y$ if $y \\leq \\hat{y} $ : the units left are equal to the units to be sold minus the real sales. \n",
    "- $0$ if $y \\geq \\hat{y} $ : there is not units left if the demand is higher than the prediction. \n",
    "\n",
    "The total cost for carrying over the not sold unit from one month to the next is : $ max(0,\\hat{y} - y) *500$ $\n",
    "\n",
    "We want to find $\\hat{y}$ which maximize the profit earns by Nissan:  $ min(y,\\hat{y}) *3000 - max(0,\\hat{y} - y) *500 $\n",
    "\n",
    "The loss fonction to minimize $l$ is thus the opposite of the total profit : \n",
    "$ l(y,\\hat{y}) = - min(y,\\hat{y}) *3000 + max(0,\\hat{y} - y) *500 $"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.8.2"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
